<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>時光節拍 (V2.0 - JSON譜面版)</title>
    <style>
        /* CSS 樣式與之前相同 */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; background-color: #1a1a1a; color: white; user-select: none; -webkit-user-select: none; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: opacity 0.5s ease; background-size: cover; background-position: center; }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { font-size: 3rem; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
        p { font-size: 1.2rem; text-shadow: 1px 1px 4px rgba(0,0,0,0.7); }
        .button { padding: 15px 30px; font-size: 1.5rem; color: white; background: linear-gradient(145deg, #2c5364, #203a43, #0f2027); border: 2px solid #fff; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.4); margin: 10px; width: 80%; max-width: 400px; }
        .button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.5); }
        #start-screen { background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://picsum.photos/800/1200?random=1'); }
        #song-select-screen .song-list { display: flex; flex-direction: column; gap: 15px; height: 80vh; overflow-y: auto; }
        #game-screen { justify-content: flex-start; }
        #loading-indicator { font-size: 1.5rem; color: #fff; background-color: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; }
        #game-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; transition: filter 0.5s ease-out; z-index: -1; }
        #game-info { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; font-size: 1.5rem; text-shadow: 2px 2px 4px #000; }
        #combo-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; color: rgba(255, 255, 255, 0.5); opacity: 0; transition: opacity 0.2s, transform 0.2s; }
        #combo-display.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        #game-canvas { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; }
        #result-screen h2 { font-size: 2.5rem; }
        #poster-preview-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100; }
        #poster-canvas { border: 2px solid white; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="start-screen" class="screen"><h1>時光節拍</h1><p>用節拍敲響青春記憶！</p><div id="start-button" class="button">開始遊戲</div></div>
    <div id="song-select-screen" class="screen hidden"><h1>選擇歌曲</h1><div class="song-list"></div></div>
    <div id="game-screen" class="screen hidden"><div id="loading-indicator">譜面載入中...</div><div id="game-background"></div><div id="game-info"><span id="score">分數: 0</span><span id="song-timer">00:00</span></div><div id="combo-display"></div><canvas id="game-canvas"></canvas></div>
    <div id="result-screen" class="screen hidden"><h2 id="result-title">演奏結束</h2><p id="result-score"></p><p id="result-accuracy"></p><p id="result-grade"></p><div class="button" id="generate-poster-button">生成勳章海報</div><div class="button" id="back-to-menu-button">返回選單</div></div>
    <div id="poster-preview-container"><canvas id="poster-canvas"></canvas></div>
    <audio id="game-audio" preload="auto"></audio>

    <script>
    // --- 遊戲設定與資源 ---
    // 歌曲數據庫現在只包含元數據和檔案路徑
    const songDatabase = [
        {
            id: 'tianmimi',
            title: '甜蜜蜜',
            artist: '鄧麗君',
            difficulty: '初級',
            audioSrc: 'audio/甜蜜蜜.mp3',
            beatmapSrc: 'beatmaps/甜蜜蜜.json', // 指向譜面檔案
            backgroundSrc: 'https://picsum.photos/800/1200?random=10',
            duration: 180, 
        },
        {
            id: 'yueliang',
            title: '月亮代表我的心',
            artist: '鄧麗君',
            difficulty: '初級',
            audioSrc: 'audio/月亮代表我的心.mp3',
            beatmapSrc: 'beatmaps/月亮代表我的心.json',
            backgroundSrc: 'https://picsum.photos/800/1200?random=11',
            duration: 210,
        },
        {
            id: 'henaini',
            title: '很愛很愛你',
            artist: '劉若英',
            difficulty: '中級',
            audioSrc: 'audio/很愛很愛你.mp3',
            beatmapSrc: 'beatmaps/很愛很愛你.json',
            backgroundSrc: 'https://picsum.photos/800/1200?random=12',
            duration: 286,
        },
        {
            id: 'tongnian',
            title: '童年',
            artist: '羅大佑',
            difficulty: '中級',
            audioSrc: 'audio/童年.mp3',
            beatmapSrc: 'beatmaps/童年.json',
            backgroundSrc: 'https://picsum.photos/800/1200?random=13',
            duration: 230,
        },
        {
            id: 'xiaosa',
            title: '瀟灑走一回',
            artist: '葉蒨文',
            difficulty: '大師級',
            audioSrc: 'audio/瀟灑走一回.mp3',
            beatmapSrc: 'beatmaps/瀟灑走一回.json',
            backgroundSrc: 'https://picsum.photos/800/1200?random=14',
            duration: 245,
        },
        {
            id: 'naner',
            title: '男兒當自強',
            artist: '林子祥',
            difficulty: '大師級',
            audioSrc: 'audio/男兒當自強.mp3',
            beatmapSrc: 'beatmaps/男兒當自強.json',
            backgroundSrc: 'https://picsum.photos/800/1200?random=15',
            duration: 262,
        },
    ];

    // --- DOM 元素獲取 ---
    const loadingIndicator = document.getElementById('loading-indicator');
    // 其他元素獲取不變
    const screens = { start: document.getElementById('start-screen'), songSelect: document.getElementById('song-select-screen'), game: document.getElementById('game-screen'), result: document.getElementById('result-screen'), };
    const startButton = document.getElementById('start-button'), songListContainer = document.querySelector('#song-select-screen .song-list'), gameCanvas = document.getElementById('game-canvas'), ctx = gameCanvas.getContext('2d'), gameBackground = document.getElementById('game-background'), scoreDisplay = document.getElementById('score'), comboDisplay = document.getElementById('combo-display'), songTimerDisplay = document.getElementById('song-timer'), gameAudio = document.getElementById('game-audio');

    // --- 遊戲狀態變數 ---
    let currentSong, score, combo, maxCombo, accuracy, hits;
    let notes = [];
    let startTime;
    let animationFrameId;
    let nextNoteIndex;
    let gameEndTime;

    // --- 初始化 ---
    function init() {
        songDatabase.forEach(song => {
            const button = document.createElement('div');
            button.classList.add('button');
            button.innerHTML = `${song.title} <br><small style="font-size: 0.9rem;">${song.artist} - ${song.difficulty}</small>`;
            button.onclick = () => startGame(song.id);
            songListContainer.appendChild(button);
        });
        startButton.onclick = () => showScreen('songSelect');
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        gameCanvas.addEventListener('pointerdown', handleTap);
        document.getElementById('generate-poster-button').onclick = generatePoster;
        document.getElementById('back-to-menu-button').onclick = () => showScreen('songSelect');
        document.getElementById('poster-preview-container').onclick = (e) => { if (e.target === e.currentTarget) e.currentTarget.style.display = 'none'; };
    }
    
    function resizeCanvas() { gameCanvas.width = window.innerWidth; gameCanvas.height = window.innerHeight; }

    // --- 新增：載入並處理譜面檔案的函數 ---
    async function loadAndProcessBeatmap(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP 錯誤！ 狀態: ${response.status}`);
            }
            const rawBeatmap = await response.json();

            // 將JSON格式轉換為遊戲內部使用的格式 [毫秒, 軌道]
            const gameBeatmap = [];
            let trackCounter = 0;
            const trackPattern = [0, 1, 2, 1]; // 一個簡單的軌道分配模式，避免單調

            for (const event of rawBeatmap) {
                if (event.type === 'tap') {
                    const timeInMs = Math.round(event.time * 1000);
                    const track = trackPattern[trackCounter % trackPattern.length];
                    gameBeatmap.push([timeInMs, track]);
                    trackCounter++;
                }
            }
            return gameBeatmap;
        } catch (error) {
            console.error("無法載入或處理譜面檔案:", error);
            alert(`譜面檔案 ${url} 載入失敗！請檢查檔案路徑是否正確，並確保您正在使用本地伺服器(Live Server)運行遊戲。`);
            return null; // 回傳 null 表示失敗
        }
    }


    // --- 遊戲核心邏輯 (修改為異步函數) ---
    async function startGame(songId) {
        // 顯示遊戲畫面和讀取中提示
        showScreen('game');
        loadingIndicator.style.display = 'block';

        currentSong = songDatabase.find(s => s.id === songId);
        
        // 動態載入譜面
        const loadedBeatmap = await loadAndProcessBeatmap(currentSong.beatmapSrc);
        
        // 如果譜面載入失敗，則中止遊戲
        if (loadedBeatmap === null) {
            showScreen('songSelect'); // 返回選歌介面
            return;
        }
        currentSong.beatmap = loadedBeatmap; // 將載入的譜面賦值給當前歌曲

        // 隱藏讀取提示
        loadingIndicator.style.display = 'none';

        // 重置狀態
        score = 0; combo = 0; maxCombo = 0; hits = { perfect: 0, good: 0, miss: 0 };
        nextNoteIndex = 0; notes = []; gameEndTime = currentSong.duration * 1000;
        
        // 準備UI和音樂
        scoreDisplay.textContent = '分數: 0';
        comboDisplay.textContent = '';
        gameBackground.style.backgroundImage = `url('${currentSong.backgroundSrc}')`;
        gameBackground.style.filter = 'blur(15px)';
        gameAudio.src = currentSong.audioSrc;
        gameAudio.currentTime = 0;
        gameAudio.onended = () => endGame();

        // 延遲開始，給玩家準備時間
        setTimeout(() => {
            startTime = performance.now();
            gameAudio.play().catch(e => console.warn("音訊播放失敗", e));
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        }, 1500);
    }
    
    // gameLoop, update, draw, handleTap 等其他函數與 V1.1 版本相同
    function gameLoop(currentTime) {
        if (!startTime) { animationFrameId = requestAnimationFrame(gameLoop); return; }
        const elapsedTime = currentTime - startTime;
        const seconds = Math.floor(elapsedTime / 1000), minutes = Math.floor(seconds / 60), displaySeconds = seconds % 60;
        songTimerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')}`;
        while (nextNoteIndex < currentSong.beatmap.length && currentSong.beatmap[nextNoteIndex][0] < elapsedTime + 2000) {
            const [time, track] = currentSong.beatmap[nextNoteIndex];
            notes.push({ time: time, track: track, y: 0, active: true });
            nextNoteIndex++;
        }
        update(elapsedTime);
        draw();
        if (elapsedTime >= gameEndTime) { endGame(); return; }
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    function update(elapsedTime) {
        const hitLineY = gameCanvas.height * 0.85; // 85% Y-position
        notes.forEach(note => {
            if (note.active) {
                const timeDiff = note.time - elapsedTime;
                note.y = hitLineY - (timeDiff * 800 / 1000); // noteSpeed = 800
                if (timeDiff < -150) { note.active = false; hits.miss++; resetCombo(); }
            }
        });
        notes = notes.filter(note => note.active || note.y < gameCanvas.height);
    }
    function draw() {
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        const numTracks = 3, trackWidth = gameCanvas.width / numTracks, hitLineY = gameCanvas.height * 0.85;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = 2;
        for (let i = 1; i < numTracks; i++) { ctx.beginPath(); ctx.moveTo(trackWidth * i, 0); ctx.lineTo(trackWidth * i, gameCanvas.height); ctx.stroke(); }
        ctx.fillStyle = 'rgba(255, 215, 0, 0.5)'; ctx.fillRect(0, hitLineY - 25, gameCanvas.width, 50);
        ctx.strokeStyle = 'gold'; ctx.lineWidth = 3; ctx.strokeRect(0, hitLineY - 25, gameCanvas.width, 50);
        notes.forEach(note => {
            if (note.active && note.y > -50 && note.y < gameCanvas.height) {
                const x = trackWidth * note.track + trackWidth / 2;
                ctx.beginPath(); ctx.arc(x, note.y, trackWidth * 0.4, 0, Math.PI * 2);
                ctx.fillStyle = 'cyan'; ctx.shadowColor = 'cyan'; ctx.shadowBlur = 15; ctx.fill(); ctx.shadowBlur = 0;
            }
        });
    }
    function handleTap(e) {
        if (!startTime) return;
        const rect = gameCanvas.getBoundingClientRect(), x = e.clientX - rect.left, track = Math.floor(x / (gameCanvas.width / 3)), elapsedTime = performance.now() - startTime;
        for (let i = 0; i < notes.length; i++) {
            const note = notes[i];
            if (note.active && note.track === track) {
                const timeDiff = Math.abs(note.time - elapsedTime);
                if (timeDiff < 150) {
                    if (timeDiff < 70) { score += 100 + combo * 5; hits.perfect++; } else { score += 50; hits.good++; }
                    combo++; maxCombo = Math.max(maxCombo, combo); updateComboDisplay(); updateBackgroundBlur(); note.active = false;
                    break;
                }
            }
        }
        scoreDisplay.textContent = `分數: ${score}`;
    }
    function resetCombo() { combo = 0; updateComboDisplay(); updateBackgroundBlur(); }
    function updateComboDisplay() { if (combo > 2) { comboDisplay.textContent = `${combo} COMBO`; comboDisplay.classList.add('show'); setTimeout(() => comboDisplay.classList.remove('show'), 200); } else { comboDisplay.textContent = ''; } }
    function updateBackgroundBlur() { const maxBlur = 15, comboForMaxClarity = 50; let blurAmount = maxBlur - (Math.min(combo, comboForMaxClarity) / comboForMaxClarity) * maxBlur; gameBackground.style.filter = `blur(${blurAmount}px)`; }
    function endGame() {
        if(!startTime) return;
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        gameAudio.pause();
        startTime = null;
        const totalNotesInBeatmap = currentSong.beatmap.length;
        const totalHits = hits.perfect + hits.good;
        accuracy = totalNotesInBeatmap > 0 ? (totalHits / totalNotesInBeatmap) * 100 : 0;
        let grade = 'C';
        if (accuracy >= 100) grade = 'S+'; else if (accuracy > 95) grade = 'S'; else if (accuracy > 90) grade = 'A'; else if (accuracy > 80) grade = 'B';
        document.getElementById('result-score').textContent = `最終分數: ${score}`;
        document.getElementById('result-accuracy').textContent = `準確率: ${accuracy.toFixed(2)}% (Perfect: ${hits.perfect}, Good: ${hits.good}, Miss: ${totalNotesInBeatmap - totalHits})`;
        document.getElementById('result-grade').textContent = `評級: ${grade}`;
        showScreen('result');
    }
    function generatePoster() { /* 海報生成函數不變 */ const posterCanvas = document.getElementById('poster-canvas'); const pCtx = posterCanvas.getContext('2d'); const width = 400; const height = 600; posterCanvas.width = width; posterCanvas.height = height; const bgImg = new Image(); bgImg.crossOrigin = "Anonymous"; bgImg.src = currentSong.backgroundSrc; bgImg.onload = () => { pCtx.drawImage(bgImg, 0, 0, width, height); pCtx.fillStyle = 'rgba(0, 0, 0, 0.6)'; pCtx.fillRect(0, 0, width, height); const grade = document.getElementById('result-grade').textContent.split(': ')[1]; pCtx.fillStyle = 'gold'; pCtx.beginPath(); pCtx.moveTo(width/2, 80); for (let i = 0; i < 5; i++) { pCtx.lineTo(width/2 + 50 * Math.cos(Math.PI * (0.9 + i * 0.8)), 80 + 50 * Math.sin(Math.PI * (0.9 + i * 0.8))); } pCtx.closePath(); pCtx.fill(); pCtx.fillStyle = 'white'; pCtx.font = 'bold 30px sans-serif'; pCtx.textAlign = 'center'; pCtx.textBaseline = 'middle'; pCtx.fillText(grade, width/2, 85); pCtx.fillStyle = 'white'; pCtx.font = 'bold 28px sans-serif'; pCtx.fillText(currentSong.title, width/2, 180); pCtx.font = '20px sans-serif'; pCtx.fillText(`分數: ${score}`, width/2, 240); pCtx.fillText(`最大連擊: ${maxCombo}`, width/2, 280); pCtx.fillText(`準確率: ${accuracy.toFixed(2)}%`, width/2, 320); pCtx.font = 'italic bold 32px sans-serif'; pCtx.fillStyle = 'cyan'; pCtx.fillText('時光節拍', width/2, 450); pCtx.font = '14px sans-serif'; pCtx.fillStyle = 'lightgray'; pCtx.fillText('長按圖片即可儲存分享', width/2, 550); document.getElementById('poster-preview-container').style.display = 'flex'; }; bgImg.onerror = () => { pCtx.fillStyle = '#333'; pCtx.fillRect(0, 0, width, height); pCtx.fillStyle = 'white'; pCtx.font = '24px sans-serif'; pCtx.textAlign = 'center'; pCtx.textBaseline = 'middle'; pCtx.fillText('背景圖片加載失敗', width/2, height/2 - 20); pCtx.font = '16px sans-serif'; pCtx.fillText('海報功能需要網路圖片', width/2, height/2 + 20); document.getElementById('poster-preview-container').style.display = 'flex'; } }

    // --- 啟動遊戲 ---
    init();
    showScreen('start');
    </script>
</body>
</html>